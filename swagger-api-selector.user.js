// ==UserScript==
// @name         Swagger API Êé•Âè£ÈÄâÊã©Âô®
// @namespace    http://tampermonkey.net/
// @version      1.0
// @description  Âú® Swagger UI È°µÈù¢Â∫ïÈÉ®Ê∑ªÂä†ÂèØÊêúÁ¥¢ÁöÑÊé•Âè£‰∏ãÊãâÊ°Ü
// @author       You
// @match        https://*/*/swagger-ui/*
// @match        http://*/*/swagger-ui/*
// @grant        none
// ==/UserScript==

(function() {
    'use strict';
    // Á≠âÂæÖÈ°µÈù¢Âä†ËΩΩÂÆåÊàê
    function waitForElement(selector, callback) {
        const element = document.querySelector(selector);
        if (element) {
            callback(element);
        } else {
            setTimeout(() => waitForElement(selector, callback), 100);
        }
    }

    // ‰ªé API ÊñáÊ°£Âú∞ÂùÄËé∑ÂèñÊé•Âè£Êï∞ÊçÆ
    async function getApiData() {
        try {
            // ‰ªéÂΩìÂâçURLÂä®ÊÄÅÊûÑÂª∫APIÊñáÊ°£Âú∞ÂùÄ
            const currentUrl = window.location.href;
            const baseUrl = currentUrl.split('/datahome/')[0] + '/datahome';
            const apiDocsUrl = `${baseUrl}/v3/api-docs`;
            
            const response = await fetch(apiDocsUrl);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const apiDoc = await response.json();
            const apiData = [];
            
            // Ëß£Êûê OpenAPI ÊñáÊ°£‰∏≠ÁöÑÊé•Âè£‰ø°ÊÅØ
            if (apiDoc.paths) {
                Object.entries(apiDoc.paths).forEach(([path, pathItem]) => {
                    // ÊîØÊåÅÁöÑ HTTP ÊñπÊ≥ï
                    const httpMethods = ['get', 'post', 'put', 'delete', 'patch', 'head', 'options'];
                    
                    Object.entries(pathItem).forEach(([method, operation]) => {
                        // Âè™Â§ÑÁêÜ HTTP ÊñπÊ≥ïÔºåË∑≥Ëøá $ref Á≠âÁâπÊÆäÂ±ûÊÄß
                        if (httpMethods.includes(method.toLowerCase()) && typeof operation === 'object') {
                            apiData.push({
                                id: apiData.length,
                                method: method.toUpperCase(),
                                path: path,
                                summary: operation.summary || operation.description || 'Êó†ÊèèËø∞',
                                fullText: `${method.toUpperCase()} ${path} ${operation.summary || operation.description || ''}`.toLowerCase(),
                                tags: operation.tags || [],
                                operationId: operation.operationId,
                                description: operation.description || ''
                            });
                        }
                    });
                });
            }
            
            console.log(`‰ªé API ÊñáÊ°£Ëé∑ÂèñÂà∞ ${apiData.length} ‰∏™Êé•Âè£`);
            return apiData;
        } catch (error) {
            console.error('Ëé∑Âèñ API Êï∞ÊçÆÂ§±Ë¥•:', error);
            // Â¶ÇÊûú API ËØ∑Ê±ÇÂ§±Ë¥•ÔºåÂõûÈÄÄÂà∞‰ªé DOM ÊèêÂèñ
            return getApiDataFromDOM();
        }
    }

    // ‰ªé DOM ÊèêÂèñÊé•Âè£Êï∞ÊçÆÔºàÂ§áÁî®ÊñπÊ°àÔºâ
    function getApiDataFromDOM() {
        const apiData = [];
        
        // ‰ªé Swagger UI ‰∏≠ÊèêÂèñÊé•Âè£‰ø°ÊÅØ
        const operationElements = document.querySelectorAll('.opblock');
        
        operationElements.forEach((element, index) => {
            const method = element.querySelector('.opblock-summary-method')?.textContent?.trim();
            const path = element.querySelector('.opblock-summary-path')?.textContent?.trim();
            const summary = element.querySelector('.opblock-summary-description')?.textContent?.trim();
            
            if (method && path) {
                apiData.push({
                    id: index,
                    method: method,
                    path: path,
                    summary: summary || 'Êó†ÊèèËø∞',
                    fullText: `${method} ${path} ${summary || ''}`.toLowerCase()
                });
            }
        });
        
        console.log(`‰ªé DOM ÊèêÂèñÂà∞ ${apiData.length} ‰∏™Êé•Âè£`);
        return apiData;
    }

    // ÂàõÂª∫ÊêúÁ¥¢‰∏ãÊãâÊ°Ü
    function createApiSelector() {
        const container = document.createElement('div');
        container.id = 'api-selector-container';
        container.innerHTML = `
            <div class="api-selector-wrapper">
                <div class="api-selector-header">
                    <h3>Êé•Âè£Âø´ÈÄüÈÄâÊã©</h3>
                    <button id="toggle-selector" class="toggle-btn">Êî∂Ëµ∑</button>
                </div>
                <div class="api-selector-content">
                    <div class="search-box">
                        <input type="text" id="api-search" placeholder="ÊêúÁ¥¢Êé•Âè£..." />
                        <div class="search-icon">üîç</div>
                    </div>
                    <div class="api-list" id="api-list">
                        <!-- Êé•Âè£ÂàóË°®Â∞ÜÂú®ËøôÈáåÂä®ÊÄÅÁîüÊàê -->
                    </div>
                </div>
            </div>
        `;

        // Ê∑ªÂä†Ê†∑Âºè
        const style = document.createElement('style');
        style.id = 'swagger-api-selector-styles';
        style.textContent = `
            #api-selector-container {
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                background: #fff;
                border-top: 2px solid #3b82f6;
                box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.15);
                z-index: 10000;
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                max-height: 60vh;
                transition: all 0.3s ease;
            }

            .api-selector-wrapper {
                padding: 16px;
            }

            .api-selector-wrapper.collapsed {
                padding: 8px 16px;
            }

            .api-selector-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 12px;
                padding-bottom: 8px;
                border-bottom: 1px solid #e5e7eb;
            }

            .api-selector-header h3 {
                margin: 0;
                color: #1f2937;
                font-size: 16px;
                font-weight: 600;
            }

            .toggle-btn {
                background: #3b82f6;
                color: white;
                border: none;
                padding: 6px 12px;
                border-radius: 6px;
                cursor: pointer;
                font-size: 12px;
                transition: background-color 0.2s;
            }

            .toggle-btn:hover {
                background: #2563eb;
            }

            .api-selector-content {
                max-height: 400px;
                overflow: hidden;
                transition: max-height 0.3s ease;
            }

            .api-selector-content.collapsed {
                max-height: 0;
                padding: 0;
                margin: 0;
            }

            .search-box {
                position: relative;
                margin-bottom: 12px;
            }

            #api-search {
                width: 100%;
                padding: 10px 40px 10px 12px;
                border: 2px solid #e5e7eb;
                border-radius: 8px;
                font-size: 14px;
                outline: none;
                transition: border-color 0.2s;
                box-sizing: border-box;
            }

            #api-search:focus {
                border-color: #3b82f6;
            }

            .search-icon {
                position: absolute;
                right: 12px;
                top: 50%;
                transform: translateY(-50%);
                color: #6b7280;
                pointer-events: none;
            }

            .api-list {
                max-height: 300px;
                overflow-y: auto;
                border: 1px solid #e5e7eb;
                border-radius: 8px;
                background: #fafafa;
            }

            .api-item {
                padding: 12px;
                border-bottom: 1px solid #e5e7eb;
                cursor: pointer;
                transition: background-color 0.2s;
                display: flex;
                align-items: flex-start;
                gap: 8px;
            }

            .api-item:last-child {
                border-bottom: none;
            }

            .api-item:hover {
                background: #f3f4f6;
            }

            .api-item.highlighted {
                background: #dbeafe;
            }

            .method-badge {
                padding: 2px 8px;
                border-radius: 4px;
                font-size: 11px;
                font-weight: 600;
                text-transform: uppercase;
                min-width: 50px;
                text-align: center;
            }

            .method-get { background: #10b981; color: white; }
            .method-post { background: #3b82f6; color: white; }
            .method-put { background: #f59e0b; color: white; }
            .method-delete { background: #ef4444; color: white; }
            .method-patch { background: #8b5cf6; color: white; }

            .api-info {
                flex: 1;
            }

            .api-path {
                font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
                font-size: 13px;
                color: #374151;
                font-weight: 500;
            }

            .api-summary {
                color: #6b7280;
                font-size: 12px;
                margin-top: 2px;
                line-height: 1.4;
            }

            .api-tags {
                color: #9ca3af;
                font-size: 11px;
                margin-top: 4px;
                font-style: italic;
            }

            .no-results {
                padding: 20px;
                text-align: center;
                color: #6b7280;
                font-style: italic;
            }

            /* ÊªöÂä®Êù°Ê†∑Âºè */
            .api-list::-webkit-scrollbar {
                width: 6px;
            }

            .api-list::-webkit-scrollbar-track {
                background: #f1f1f1;
                border-radius: 3px;
            }

            .api-list::-webkit-scrollbar-thumb {
                background: #c1c1c1;
                border-radius: 3px;
            }

            .api-list::-webkit-scrollbar-thumb:hover {
                background: #a8a8a8;
            }
            
            /* Âº∫Âà∂Ê†∑Âºè‰ºòÂÖàÁ∫ß */
            #api-selector-container * {
                box-sizing: border-box !important;
            }
            
            #api-selector-container {
                display: block !important;
                visibility: visible !important;
                opacity: 1 !important;
            }
            
            /* Âä®ÁîªÊ†∑Âºè */
            @keyframes slideIn {
                from {
                    transform: translateX(100%);
                    opacity: 0;
                }
                to {
                    transform: translateX(0);
                    opacity: 1;
                }
            }
        `;

        // Á°Æ‰øùÊ†∑ÂºèÊ≠£Á°ÆÂ∫îÁî®
        if (!document.getElementById('swagger-api-selector-styles')) {
            document.head.appendChild(style);
        }
        
        // Â§áÁî®Ê†∑ÂºèÂ∫îÁî®ÊñπÊ≥ï
        setTimeout(() => {
            const existingStyle = document.getElementById('swagger-api-selector-styles');
            if (!existingStyle) {
                document.head.appendChild(style.cloneNode(true));
            }
        }, 100);
        
        document.body.appendChild(container);
        
        // Âº∫Âà∂Â∫îÁî®ÂÜÖËÅîÊ†∑Âºè‰Ωú‰∏∫Â§áÁî®
        container.style.cssText = `
            position: fixed !important;
            bottom: 0 !important;
            left: 0 !important;
            right: 0 !important;
            background: #fff !important;
            border-top: 2px solid #3b82f6 !important;
            box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.15) !important;
            z-index: 10000 !important;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif !important;
            max-height: 60vh !important;
            display: block !important;
            visibility: visible !important;
        `;

        return container;
    }

    // Ê∏≤ÊüìÊé•Âè£ÂàóË°®
    function renderApiList(apiData, searchTerm = '') {
        const apiList = document.getElementById('api-list');
        if (!apiList) return;

        const filteredData = apiData.filter(api => 
            api.fullText.includes(searchTerm.toLowerCase())
        );

        if (filteredData.length === 0) {
            apiList.innerHTML = '<div class="no-results">Êú™ÊâæÂà∞ÂåπÈÖçÁöÑÊé•Âè£</div>';
            return;
        }

        apiList.innerHTML = filteredData.map(api => `
            <div class="api-item" data-path="${api.path}" data-method="${api.method}" data-operation-id="${api.operationId || ''}" data-tags="${api.tags ? api.tags.join(',') : ''}">
                <span class="method-badge method-${api.method.toLowerCase()}">${api.method}</span>
                <div class="api-info">
                    <div class="api-path">${api.path}</div>
                    <div class="api-summary">${api.summary}</div>
                    ${api.tags && api.tags.length > 0 ? `<div class="api-tags">Ê†áÁ≠æ: ${api.tags.join(', ')}</div>` : ''}
                </div>
            </div>
        `).join('');

        // Ê∑ªÂä†ÁÇπÂáª‰∫ã‰ª∂
        apiList.querySelectorAll('.api-item').forEach(item => {
            item.addEventListener('click', async () => {
                const path = item.dataset.path;
                const method = item.dataset.method;
                const operationId = item.dataset.operationId;
                const tags = item.dataset.tags ? item.dataset.tags.split(',') : [];
                
                // ‰ΩøÁî®Êñ∞ÁöÑÂÆö‰ΩçÂáΩÊï∞ÔºàÁé∞Âú®ÊòØÂºÇÊ≠•ÁöÑÔºâ
                const targetElement = await findApiElement(path, method, operationId, tags);
                
                if (targetElement) {
                    
                    // ÊªöÂä®Âà∞ÁõÆÊ†áÂÖÉÁ¥†
                    targetElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    
                    // È´ò‰∫ÆÊòæÁ§∫
                    const originalBorder = targetElement.style.border;
                    const originalBorderRadius = targetElement.style.borderRadius;
                    const originalBoxShadow = targetElement.style.boxShadow;
                    
                    targetElement.style.border = '3px solid #3b82f6';
                    targetElement.style.borderRadius = '6px';
                    targetElement.style.boxShadow = '0 0 10px rgba(59, 130, 246, 0.5)';
                    
                    // Â±ïÂºÄÊé•Âè£ËØ¶ÊÉÖ
                    const summaryElement = targetElement.querySelector('.opblock-summary');
                    if (summaryElement) {
                        summaryElement.click();
                    }
                    
                    // ÊÅ¢Â§çÊ†∑Âºè
                    setTimeout(() => {
                        targetElement.style.border = originalBorder;
                        targetElement.style.borderRadius = originalBorderRadius;
                        targetElement.style.boxShadow = originalBoxShadow;
                    }, 3000);
                    
                    // ÊêúÁ¥¢ÂÆåÊàêÂêéÊî∂Ëµ∑‰∏ãÊãâÊ°Ü
                    const content = document.querySelector('.api-selector-content');
                    const wrapper = document.querySelector('.api-selector-wrapper');
                    const toggleBtn = document.getElementById('toggle-selector');
                    if (content && wrapper && toggleBtn) {
                        content.classList.add('collapsed');
                        wrapper.classList.add('collapsed');
                        toggleBtn.textContent = 'Â±ïÂºÄ';
                    }
                } else {
                    showErrorMessage(`Êú™ÊâæÂà∞Êé•Âè£: ${method} ${path}`);
                }
            });
        });
    }

    // ÂàùÂßãÂåñÊêúÁ¥¢ÂäüËÉΩ
    function initSearch(apiData) {
        const searchInput = document.getElementById('api-search');
        if (!searchInput) return;

        let searchTimeout;
        searchInput.addEventListener('input', (e) => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                renderApiList(apiData, e.target.value);
            }, 150);
        });

        // ÈîÆÁõòÂØºËà™
        let selectedIndex = -1;
        searchInput.addEventListener('keydown', (e) => {
            const items = document.querySelectorAll('.api-item');
            
            if (e.key === 'ArrowDown') {
                e.preventDefault();
                selectedIndex = Math.min(selectedIndex + 1, items.length - 1);
                updateSelection(items, selectedIndex);
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                selectedIndex = Math.max(selectedIndex - 1, -1);
                updateSelection(items, selectedIndex);
            } else if (e.key === 'Enter' && selectedIndex >= 0) {
                e.preventDefault();
                items[selectedIndex]?.click();
            } else if (e.key === 'Escape') {
                searchInput.blur();
            }
        });

        function updateSelection(items, index) {
            items.forEach((item, i) => {
                item.classList.toggle('highlighted', i === index);
            });
        }
    }

    // ÂàùÂßãÂåñÊäòÂè†ÂäüËÉΩ
    function initToggle() {
        const toggleBtn = document.getElementById('toggle-selector');
        const content = document.querySelector('.api-selector-content');
        const wrapper = document.querySelector('.api-selector-wrapper');
        
        if (!toggleBtn || !content || !wrapper) return;

        let isCollapsed = false;
        
        toggleBtn.addEventListener('click', () => {
            isCollapsed = !isCollapsed;
            content.classList.toggle('collapsed', isCollapsed);
            wrapper.classList.toggle('collapsed', isCollapsed);
            toggleBtn.textContent = isCollapsed ? 'Â±ïÂºÄ' : 'Êî∂Ëµ∑';
        });
    }


    // ÊòæÁ§∫ÈîôËØØÊ∂àÊÅØ
    function showErrorMessage(message) {
        const toast = document.createElement('div');
        toast.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: #ef4444;
            color: white;
            padding: 12px 16px;
            border-radius: 6px;
            font-size: 14px;
            z-index: 10001;
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
            animation: slideIn 0.3s ease;
        `;
        toast.textContent = `‚ùå ${message}`;
        document.body.appendChild(toast);
        
        setTimeout(() => {
            if (toast.parentNode) {
                toast.parentNode.removeChild(toast);
            }
        }, 5000);
    }

    // Á≠âÂæÖ Swagger UI ÂÆåÂÖ®Âä†ËΩΩ
    function waitForSwaggerUI() {
        return new Promise((resolve) => {
            let attempts = 0;
            const maxAttempts = 20; // ÊúÄÂ§öÁ≠âÂæÖ10Áßí
            
            const checkSwaggerUI = () => {
                attempts++;
                console.log(`Ê£ÄÊü• Swagger UI Âä†ËΩΩÁä∂ÊÄÅ (${attempts}/${maxAttempts})...`);
                
                const swaggerUI = document.querySelector('.swagger-ui');
                const opblocks = document.querySelectorAll('.opblock');
                const swaggerContainer = document.querySelector('#swagger-ui');
                
                // Êõ¥ÂÆΩÊùæÁöÑÊ£ÄÊµãÊù°‰ª∂
                if (swaggerUI || swaggerContainer) {
                    console.log(`Swagger UI Â∑≤Âä†ËΩΩÔºåÊâæÂà∞ ${opblocks.length} ‰∏™Êé•Âè£Âùó`);
                    resolve();
                    return;
                }
                
                // Â¶ÇÊûúËææÂà∞ÊúÄÂ§ßÂ∞ùËØïÊ¨°Êï∞ÔºåÂº∫Âà∂ÁªßÁª≠
                if (attempts >= maxAttempts) {
                    console.log('ËææÂà∞ÊúÄÂ§ßÁ≠âÂæÖÊó∂Èó¥ÔºåÂº∫Âà∂ÁªßÁª≠ÂàùÂßãÂåñ');
                    resolve();
                    return;
                }
                
                console.log('Á≠âÂæÖ Swagger UI Âä†ËΩΩ...');
                setTimeout(checkSwaggerUI, 500);
            };
            checkSwaggerUI();
        });
    }

    // Ê≠£Á°ÆÁöÑÊé•Âè£ÂÆö‰ΩçÂáΩÊï∞
    function findApiElement(path, method, operationId, tags = []) {
        return new Promise((resolve) => {
            // 1. ÂÖàÊâæÂà∞Êé•Âè£ÊâÄÂ±ûÁöÑÊ†áÁ≠æ
            const targetTag = findTargetTag(path, method, tags);
            
            if (!targetTag) {
                resolve(null);
                return;
            }
            
            // 2. Â±ïÂºÄÁõÆÊ†áÊ†áÁ≠æ
            const isOpen = targetTag.dataset.isOpen === 'true';
            if (!isOpen) {
                targetTag.click();
            }
            
            // 3. Á≠âÂæÖÊ†áÁ≠æÂ±ïÂºÄÂêéÊü•ÊâæÊé•Âè£
            setTimeout(() => {
                const targetApi = findApiInTag(targetTag, path, method);
                resolve(targetApi);
            }, 100);
        });
    }
    
    // Êü•ÊâæÊé•Âè£ÊâÄÂ±ûÁöÑÊ†áÁ≠æ
    function findTargetTag(path, method, tags = []) {
        // Êü•ÊâæÊâÄÊúâÊ†áÁ≠æ
        const allTags = document.querySelectorAll('.opblock-tag');
        
        // 1. ‰ºòÂÖàÈÄöËøá API tags ÂåπÈÖç
        if (tags.length > 0) {
            for (const apiTag of tags) {
                for (const tag of allTags) {
                    const tagName = tag.dataset.tag;
                    if (tagName && tagName.toLowerCase() === apiTag.toLowerCase()) {
                        return tag;
                    }
                }
            }
        }
        
        // 2. Â¶ÇÊûú API tags Ê≤°ÂåπÈÖçÂà∞ÔºåÊ†πÊçÆË∑ØÂæÑÊé®Êñ≠Ê†áÁ≠æÂêçÁß∞
        const pathSegments = path.split('/').filter(segment => segment && !segment.startsWith('{'));
        const possibleTags = pathSegments.slice(0, 2); // ÂèñÂâç‰∏§‰∏™Ë∑ØÂæÑÊÆµ‰Ωú‰∏∫ÂèØËÉΩÁöÑÊ†áÁ≠æ
        
        for (const tag of allTags) {
            const tagName = tag.querySelector('.opblock-tag-section h4')?.textContent?.trim();
            if (tagName) {
                // Ê£ÄÊü•Ê†áÁ≠æÂêçÊòØÂê¶ÂåÖÂê´Ë∑ØÂæÑÁöÑÂÖ≥ÈîÆÈÉ®ÂàÜ
                const hasMatch = possibleTags.some(segment => 
                    tagName.toLowerCase().includes(segment.toLowerCase())
                );
                
                if (hasMatch) {
                    return tag;
                }
            }
        }
        
        // 3. Â¶ÇÊûúÈÉΩÊ≤°ÊâæÂà∞ÂåπÈÖçÁöÑÊ†áÁ≠æÔºåËøîÂõûÁ¨¨‰∏Ä‰∏™Ê†áÁ≠æ‰Ωú‰∏∫ÈªòËÆ§
        if (allTags.length > 0) {
            return allTags[0];
        }
        
        return null;
    }
    
    // Âú®ÊåáÂÆöÊ†áÁ≠æ‰∏ãÊü•ÊâæÊé•Âè£
    function findApiInTag(tag, path, method) {
        // ÊâæÂà∞Ê†áÁ≠æ‰∏ãÁöÑÊâÄÊúâÊé•Âè£
        const tagSection = tag.nextElementSibling;
        if (!tagSection) {
            return null;
        }
        
        const apis = tagSection.querySelectorAll('.opblock');
        
        for (const api of apis) {
            const pathEl = api.querySelector('.opblock-summary-path');
            const methodEl = api.querySelector('.opblock-summary-method');
            
            if (pathEl && methodEl) {
                const apiPath = pathEl.dataset.path;
                const apiMethod = methodEl.textContent.trim().toLowerCase();
                
                if (apiPath === path && apiMethod === method.toLowerCase()) {
                    return api;
                }
            }
        }
        
        return null;
    }

    // ‰∏ªÂáΩÊï∞
    async function init() {
        try {
            // ÂàõÂª∫ÈÄâÊã©Âô®Ôºà‰∏çÁ≠âÂæÖ Swagger UIÔºâ
            createApiSelector();
            
            // ÊòæÁ§∫Âä†ËΩΩÁä∂ÊÄÅ
            const apiList = document.getElementById('api-list');
            if (apiList) {
                apiList.innerHTML = '<div class="no-results">Ê≠£Âú®Âä†ËΩΩÊé•Âè£Êï∞ÊçÆ...</div>';
            }
            
            // Ëé∑ÂèñÊé•Âè£Êï∞ÊçÆ
            const apiData = await getApiData();
            
            if (apiData.length === 0) {
                // Á≠âÂæÖ‰∏Ä‰∏ãÂÜçÂ∞ùËØï‰ªé DOM ÊèêÂèñ
                setTimeout(async () => {
                    const domData = getApiDataFromDOM();
                    if (domData.length > 0) {
                        renderApiList(domData);
                        initSearch(domData);
                        initToggle();
                    } else {
                        if (apiList) {
                            apiList.innerHTML = '<div class="no-results">Êú™ÊâæÂà∞Êé•Âè£Êï∞ÊçÆ</div>';
                        }
                    }
                }, 2000);
                return;
            }
            
            // ÂàùÂßãÂåñÂäüËÉΩ
            renderApiList(apiData);
            initSearch(apiData);
            initToggle();
            
            // Ê£ÄÊü•Ê†∑ÂºèÊòØÂê¶Ê≠£Á°ÆÂ∫îÁî®
            setTimeout(() => {
                const container = document.getElementById('api-selector-container');
                if (container) {
                    const styles = window.getComputedStyle(container);
                    
                    if (styles.display === 'none' || styles.visibility === 'hidden') {
                        container.style.display = 'block';
                        container.style.visibility = 'visible';
                    }
                }
            }, 1000);
            
        } catch (error) {
            console.error('ÂàùÂßãÂåñÂ§±Ë¥•:', error);
            const apiList = document.getElementById('api-list');
            if (apiList) {
                apiList.innerHTML = '<div class="no-results">Âä†ËΩΩÂ§±Ë¥•ÔºåËØ∑Âà∑Êñ∞È°µÈù¢ÈáçËØï</div>';
            }
        }
    }

    // Èò≤Ê≠¢ÈáçÂ§çÂàùÂßãÂåñ
    if (window.swaggerApiSelectorInitialized) {
        return;
    }
    window.swaggerApiSelectorInitialized = true;

    // ÂêØÂä®ËÑöÊú¨
    
    // Á≠âÂæÖÈ°µÈù¢Âä†ËΩΩÂÆåÊàêÂêéÂÜçÂêØÂä®
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
    } else {
        // È°µÈù¢Â∑≤ÁªèÂä†ËΩΩÂÆåÊàêÔºåÂª∂Ëøü‰∏Ä‰∏ãÂêØÂä®
        setTimeout(init, 1000);
    }
})();
